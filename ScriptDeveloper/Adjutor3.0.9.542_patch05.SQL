UPDATE  VERSAOSISTEMA 
SET VERSAOSISTEMA.SCRIPTADJUTOR = '3.0.9.542 patch 5',
       VERSAOSISTEMA.DATA   = '25.03.2020',
	    VERSAO = '3.0.9.542'
 where VERSAOSISTEMA.CODIGO = 1;

commit work; 


DELETE FROM PRD_UNIDADE;

INSERT INTO PRD_UNIDADE VALUES (0, 1, 'UN', 'Unidade', '001');
INSERT INTO PRD_UNIDADE VALUES (1, 2, 'PC', 'Peca', '001');
INSERT INTO PRD_UNIDADE VALUES (2, 3, 'BD', 'Balde', '001');
INSERT INTO PRD_UNIDADE VALUES (3, 4, 'BR', 'Barril', '001');
INSERT INTO PRD_UNIDADE VALUES (4, 5, 'CX', 'Caixa', '001');
INSERT INTO PRD_UNIDADE VALUES (5, 6, 'EMB', 'Embalagem', '001');
INSERT INTO PRD_UNIDADE VALUES (6, 7, 'FD', 'Fardo', '001');
INSERT INTO PRD_UNIDADE VALUES (7, 8, 'FR', 'Frasco ', '001');
INSERT INTO PRD_UNIDADE VALUES (8, 9, 'GL', 'Galão', '001');
INSERT INTO PRD_UNIDADE VALUES (9, 10, 'GR', 'Grama', '001');
INSERT INTO PRD_UNIDADE VALUES (10, 11, 'LT', 'Litro', '001');
INSERT INTO PRD_UNIDADE VALUES (11, 12, 'ML', 'Mililitro', '001');
INSERT INTO PRD_UNIDADE VALUES (12, 13, 'MT', 'Metro', '001');
INSERT INTO PRD_UNIDADE VALUES (13, 14, 'M2', 'Metro Quadrado', '001');
INSERT INTO PRD_UNIDADE VALUES (14, 15, 'M3', 'Metro Cubico', '001');
INSERT INTO PRD_UNIDADE VALUES (15, 16, 'MIL', 'Milheiro', '001');
INSERT INTO PRD_UNIDADE VALUES (16, 17, 'PCT', 'Pacote', '001');
INSERT INTO PRD_UNIDADE VALUES (17, 18, 'KG', 'Quilograma', '001');
INSERT INTO PRD_UNIDADE VALUES (18, 19, 'RL', 'Rolo', '001');
INSERT INTO PRD_UNIDADE VALUES (19, 20, 'CT', 'Cento', '001');
INSERT INTO PRD_UNIDADE VALUES (20, 21, 'LA', 'Lata', '001');
INSERT INTO PRD_UNIDADE VALUES (21, 22, 'T', 'Tonel', '001');
INSERT INTO PRD_UNIDADE VALUES (22, 23, 'PAR', 'Pares', '001');
INSERT INTO PRD_UNIDADE VALUES (23, 24, 'CJ', 'Conjunto', '001');
INSERT INTO PRD_UNIDADE VALUES (24, 25, 'TB', 'Tambor', '001');
INSERT INTO PRD_UNIDADE VALUES (25, 25, 'KIT', 'KIT de produtos', '001');
INSERT INTO PRD_UNIDADE VALUES (26, 26, 'MM', 'Milimetro', '001');
INSERT INTO PRD_UNIDADE VALUES (27, 27, 'KWH', 'Kilowatts (Energia)', '001');
INSERT INTO PRD_UNIDADE VALUES (28, 28, 'BOB', 'Bobina', '001');
INSERT INTO PRD_UNIDADE VALUES (29, 29, 'HR', 'Hora (refere-se a seviço)', '001');
INSERT INTO PRD_UNIDADE VALUES (30, 30, 'SC', 'Saco', '001');
INSERT INTO PRD_UNIDADE VALUES (31, 31, 'EX', 'Exemplar', '001');
INSERT INTO PRD_UNIDADE VALUES (32, 32, 'JG', 'Jogo', '001');
INSERT INTO PRD_UNIDADE VALUES (33, 33, 'DL', 'Decilitro','001');
INSERT INTO PRD_UNIDADE VALUES (34,34,'S50','SACO 50','001');
INSERT INTO PRD_UNIDADE VALUES (35,35,'SO','SACO','001'); 
INSERT INTO PRD_UNIDADE VALUES (36,36,'MH','MILHEIRO','001');
INSERT INTO PRD_UNIDADE VALUES (37,37,'TON','TONELADA','001');
INSERT INTO PRD_UNIDADE VALUES (38,38,'CA','CAIXA','001');
INSERT INTO PRD_UNIDADE VALUES (39,39,'TN','TONELADA','001');
INSERT INTO PRD_UNIDADE  VALUES (40,40,'CENTO','CENTO','001');
INSERT INTO PRD_UNIDADE  VALUES (41,41,'UND','UND','001');
INSERT INTO PRD_UNIDADE  VALUES (42,42,'KT','KT','001');

COMMIT WORK;

ALTER TABLE PRMT0001 ADD pmt_CaminhoFoto VARCHAR(100);
COMMENT ON COLUMN PRMT0001.pmt_CaminhoFoto IS 'CAMINHO DA FOTO ';
 
COMMENT ON COLUMN TAREFAS_CRM.TRF_ACAO IS 'ACAO PARA SE TOMAR NA TAREFA : 0 -EMAIL, 1-LIGACAO, 2-VISITA, 3- PROPOSTA, 4-POS-Venda,5 -Venda efetiva,6 -REUNIAO, 7-MANUTENCAO, 8-ORCAMENTO';
COMMENT ON COLUMN TAREFAS_CRM.TRF_ORIGEM IS 'ORIGEM DO CONTATO FOI : 0 -CLIENTE, 1-EMAIL MKT, 2-SITE,3- INDICACAO, 4-PROSPRECCAO; 5- televendas - 6-OUTROS ';

ALTER TABLE TAREFAS_CRM ADD PED_CODIGO VARCHAR(7);
COMMENT ON COLUMN TAREFAS_CRM.PED_CODIGO IS 'CHAVE REFERENCIA DO PEDIDO (PED0000)';


ALTER TABLE PRMT0001 ADD PMT_ICMS_CUSTOENTRADA VARCHAR(1);
ALTER TABLE PRMT0001 ADD PMT_PIS_CUSTOENTRADA VARCHAR(1);

COMMENT ON COLUMN PRMT0001.PMT_ICMS_CUSTOENTRADA IS 'RETIRAR ICMS DO CUSTO DE ENTRADA  S : SIM N : NAO';
COMMENT ON COLUMN PRMT0001.PMT_PIS_CUSTOENTRADA IS 'RETIRAR PIS/COFINS DO CUSTO DE ENTRADA  S : SIM N : NAO';

UPDATE PRMT0001
SET PMT_ICMS_CUSTOENTRADA = 'N'
, PMT_PIS_CUSTOENTRADA = 'N';

commit work;

ALTER TABLE PRD0000 ADD PRD_IMPOSTOS_RETIRADOS NUMERIC(18,5) ;
COMMENT ON COLUMN PRD0000.PRD_IMPOSTOS_RETIRADOS IS 'VALOR DE IMPOSTOS RETIRADOS DO CUSTO DE ENTRADA';


CREATE OR ALTER VIEW LISTA_RATEIO_VIEW_EMISSAO (EMP_CODIGO, PCX_CODIGO, EMISSAO, PAGO, RECEBIDO)
AS
SELECT Emp_codigo, pcx_codigo, Emissao, SUM(Pago) pago , sum( RECEBIDO) recebido
FROM (
select  ra.Emp_codigo, ra.pcx_codigo, pc.PPC_DTEMIS as Emissao,
         ( ra.FIR_INDICE_REAL * ( pc.PPC_VLPARC - pc.PPC_VALOR_N_RATEIA) ) as Pago, 0.00 as Recebido
from FIN_RATEIO ra
    JOIN PAG_PC01 pc on pc.emp_codigo=ra.emp_codigo AND pc.PAG_REGISTRO = ra.FIR_REGISTRO_CP_CR and pc.PPC_exclusao<>'S'
WHERE ra.FIR_REGISTRO_TIPO = 'P' AND ra.FIR_INDICE > 0
AND pc.PPC_DTEMIS IS NOT NULL 
union all
select  ra.Emp_codigo, ra.pcx_codigo, pc.FPC_DTEMIS as Emissao,
        0.00 as Pago, ( ra.FIR_INDICE_REAL * pc.FPC_VLPARC ) as Recebido
from FIN_RATEIO ra
    JOIN FAT_PC01 pc ON pc.emp_codigo=ra.emp_codigo AND pc.FAT_REGISTRO = ra.FIR_REGISTRO_CP_CR and pc.FPC_exclusao<>'S'
WHERE ra.FIR_REGISTRO_TIPO = 'P' AND ra.FIR_INDICE > 0)
Group By 1,2,3;


CREATE OR ALTER VIEW RATEIO_SEMANA_VIEW_EMISSAO (EMP_CODIGO, PCX_CODIGO, SEMANA, PAGO, RECEBIDO, DTMIN, DTMAX)
AS
select a.emp_codigo,  a.pcx_codigo,LPAD(EXTRACT( WEEK FROM a.EMISSAO ),2,'0')   ||'/'||cast(Extract(year from a.EMISSAO) as char(4)) as Semana, Sum(a.pago) as pago, Sum(a.recebido) as recebido, Min(a.EMISSAO) as DtMin, Max(a.EMISSAO) as DtMax
from    LISTA_RATEIO_VIEW_EMISSAO a
    join pcx0000 b on b.pcx_codigo=a.pcx_codigo
group by 1,2,3;
 
 
CREATE OR ALTER VIEW RESUMO_MENSAL_VIEW_EMISSAO (EMP_CODIGO, PCX_CODIGO, MES, PAGO, RECEBIDO, DTMIN, DTMAX)
AS
select a.emp_codigo,  a.pcx_codigo, wy.rnum as Mes, Sum(a.pago) as pago, Sum(a.recebido) as recebido, Min(a.EMISSAO) as DtMin, Max(a.EMISSAO) as DtMax
from    LISTA_RATEIO_VIEW_EMISSAO a
    join pcx0000 b on b.pcx_codigo=a.pcx_codigo
    join MesOfTheYear (a.EMISSAO) WY on 1=1
group by 1,2,3;

CREATE OR ALTER VIEW RATEIO_BIMESTRE_VIEW_EMISSAO (EMP_CODIGO, PCX_CODIGO, BIMESTRE, PAGO, RECEBIDO, DTMIN, DTMAX)
AS
select a.emp_codigo,  a.pcx_codigo, wy.rnum as Bimestre, Sum(a.pago) as pago, Sum(a.recebido) as recebido, Min(a.EMISSAO) as DtMin, Max(a.EMISSAO) as DtMax
from    LISTA_RATEIO_VIEW_EMISSAO a
    join pcx0000 b on b.pcx_codigo=a.pcx_codigo
    join BiOfTheYear (a.EMISSAO) WY on 1=1
group by 1,2,3;

CREATE OR ALTER VIEW RATEIO_TRIMESTRE_VIEW_EMISSAO (EMP_CODIGO, PCX_CODIGO, TRIMESTRE, PAGO, RECEBIDO, DTMIN, DTMAX)
AS
select a.emp_codigo,  a.pcx_codigo, wy.rnum as Trimestre, Sum(a.pago) as pago, Sum(a.recebido) as recebido, Min(a.EMISSAO) as DtMin, Max(a.EMISSAO) as DtMax
from    LISTA_RATEIO_VIEW_EMISSAO a
    join pcx0000 b on b.pcx_codigo=a.pcx_codigo
    join TriOfTheYear (a.EMISSAO) WY on 1=1
group by 1,2,3;

CREATE OR ALTER VIEW RATEIO_SEMESTRE_VIEW_EMISSAO (EMP_CODIGO, PCX_CODIGO, SEMESTRE, PAGO, RECEBIDO, DTMIN, DTMAX)
AS
select a.emp_codigo,  a.pcx_codigo, wy.rnum as Semestre, Sum(a.pago) as pago, Sum(a.recebido) as recebido, Min(a.EMISSAO) as DtMin, Max(a.EMISSAO) as DtMax
from    LISTA_RATEIO_VIEW_EMISSAO a
    join pcx0000 b on b.pcx_codigo=a.pcx_codigo
    join SemOfTheYear (a.EMISSAO) WY on 1=1
group by 1,2,3;


CREATE OR ALTER VIEW RATEIO_ANO_VIEW_EMISSAO (EMP_CODIGO, PCX_CODIGO, ANO, PAGO, RECEBIDO, DTMIN, DTMAX)
AS
select a.emp_codigo,  a.pcx_codigo, Extract( year from a.EMISSAO ) as Ano,  SUM(CAST(a.pago AS numeric(18,5))) as pago,  Sum(CAST(a.recebido AS NUMERIC(18,5))) as recebido, Min(a.EMISSAO) as DtMin, Max(a.EMISSAO) as DtMax
from    LISTA_RATEIO_VIEW_EMISSAO a
    join pcx0000 b on b.pcx_codigo=a.pcx_codigo
group by 1,2,3;
