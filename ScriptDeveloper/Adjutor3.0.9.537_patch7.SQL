UPDATE  VERSAOSISTEMA 
SET VERSAOSISTEMA.SCRIPTADJUTOR = '3.0.9.537 patch 7',
       VERSAOSISTEMA.DATA   = '29.10.2019',
	    VERSAO = '3.0.9.537'
 where VERSAOSISTEMA.CODIGO = 1;

COMMIT WORK;

ALTER TABLE PROCESSOS_OPERACOES DROP CONSTRAINT FK_PROCESSOS_OPERACOES;

ALTER TABLE PROCESSOS_OPERACOES
ADD CONSTRAINT FK_PROCESSOS_OPERACOES
FOREIGN KEY (OPE_CODIGO)
REFERENCES OPERACOES(OPE_CODIGO)
ON DELETE SET NULL
ON UPDATE CASCADE
USING INDEX FK_PROCESSOS_OPERACOES;


ALTER TABLE FABRICACAO DROP CONSTRAINT FK_FAB_OPERACAO;

ALTER TABLE FABRICACAO
ADD CONSTRAINT FK_FAB_OPERACAO
FOREIGN KEY (OPE_CODIGO)
REFERENCES OPERACOES(OPE_CODIGO)
ON DELETE SET NULL
ON UPDATE CASCADE
USING INDEX FK_FAB_OPERACAO;

ALTER TABLE ENGENHARIA_PROCESSO DROP CONSTRAINT FK_ENG_OPERACAO;

ALTER TABLE ENGENHARIA_PROCESSO
ADD CONSTRAINT FK_ENG_OPERACAO
FOREIGN KEY (OPE_CODIGO)
REFERENCES OPERACOES(OPE_CODIGO)
ON DELETE SET NULL
ON UPDATE CASCADE
USING INDEX FK_ENG_OPERACAO;

COMMENT ON TABLE ESPECIFICACOES_OPERACAO IS 'PARAMETROS DE PRODUCAO PARA CADA OPERACAO';


CREATE TABLE ESPE_OPERACAO_RESUL (
    EOR_CODIGO INTEGER NOT NULL,
    OPE_CODIGO INTEGER NOT NULL,
    EOR_SEQ INTEGER,
    EOR_NOME VARCHAR(100));

ALTER TABLE ESPE_OPERACAO_RESUL
ADD CONSTRAINT PK_ESPE_OPERACAO_RESUL
PRIMARY KEY (EOR_CODIGO);

COMMENT ON COLUMN ESPE_OPERACAO_RESUL.EOR_CODIGO IS 'IDENTIFICADOR';
COMMENT ON COLUMN ESPE_OPERACAO_RESUL.OPE_CODIGO IS 'REFERENCIA DA OPERACAO';
COMMENT ON COLUMN ESPE_OPERACAO_RESUL.EOR_SEQ IS 'SEQUENCIA';
COMMENT ON COLUMN ESPE_OPERACAO_RESUL.EOR_NOME IS 'NOME DO RESULTADO';
CREATE SEQUENCE GEN_ESPE_OPERACAO_RESUL;

SET TERM ^ ;

create trigger espe_operacao_resul_bi for espe_operacao_resul
active before insert position 0
as
begin
  if (new.eor_codigo is null) then
    new.eor_codigo = gen_id(gen_espe_operacao_resul,1);
end^

SET TERM ; ^

COMMENT ON TABLE ESPE_OPERACAO_RESUL IS 'PARAMETROS DE RESULTADO PARA CADA OPERACAO';


ALTER TABLE ESPE_OPERACAO_RESUL
ADD CONSTRAINT FK_ESPECIFICA_RESUL_OPERACAO
FOREIGN KEY (OPE_CODIGO)
REFERENCES OPERACOES(OPE_CODIGO)
ON DELETE CASCADE
ON UPDATE CASCADE;


CREATE TABLE RESULTADO_ESPECIFICACOES (
    RES_CODIGO INTEGER NOT NULL,
    IOP_CODIGO INTEGER NOT NULL,
    EOR_CODIGO INTEGER NOT NULL,
    EOR_VALOR VARCHAR(100));

ALTER TABLE RESULTADO_ESPECIFICACOES
ADD CONSTRAINT PK_RESULTADO_ESPECIFICACOES
PRIMARY KEY (RES_CODIGO);

COMMENT ON COLUMN RESULTADO_ESPECIFICACOES.IOP_CODIGO IS 'ORDEM DE SERVICO (ITEM_ORDEMPRODUCAO)';
COMMENT ON COLUMN RESULTADO_ESPECIFICACOES.EOR_CODIGO IS 'REFERENCIA DA ESPECIFICACOES(ESPE_OPERACAO_RESUL)';
COMMENT ON COLUMN RESULTADO_ESPECIFICACOES.EOR_VALOR IS 'RESULTADO';

CREATE SEQUENCE GEN_RESULTADO_ESPECIFICACOES;

SET TERM ^ ;

create trigger resultado_especificacoes_bi for resultado_especificacoes
active before insert position 0
as
begin
  if (new.res_codigo is null) then
    new.res_codigo = gen_id(gen_resultado_especificacoes,1);
end^

SET TERM ; ^

COMMENT ON TABLE RESULTADO_ESPECIFICACOES IS 'RESULTADO DAS INSPECOES DE QUALIDADE DE PRODUCAO';

ALTER TABLE RESULTADO_ESPECIFICACOES
ADD CONSTRAINT FK_RESULTADO_ESPECIFICACOES_1
FOREIGN KEY (IOP_CODIGO)
REFERENCES ITEM_ORDEMPRODUCAO(IOP_CODIGO)
ON DELETE CASCADE
ON UPDATE CASCADE;


ALTER TABLE RESULTADO_ESPECIFICACOES
ADD CONSTRAINT FK_RESULTADO_ESPECIFICACOES_2
FOREIGN KEY (EOR_CODIGO)
REFERENCES ESPE_OPERACAO_RESUL(EOR_CODIGO)
ON DELETE CASCADE
ON UPDATE CASCADE;



ALTER TABLE OPERACOES ADD OPE_TEMRESULTADO VARCHAR(1);
COMMENT ON COLUMN OPERACOES.OPE_TEMRESULTADO IS ' TEM RELATORIO DE RESULTADO';

UPDATE OPERACOES
SET OPE_TEMRESULTADO = 'N';

ALTER TABLE CARGA ADD CAR_DTPREVINI TIMESTAMP;
ALTER TABLE CARGA ADD CAR_DTPREVFIM TIMESTAMP;
ALTER TABLE CARGA ADD OPE_CODIGO INTEGER;

COMMENT ON COLUMN CARGA.CAR_DTPREVINI IS 'DATA DA PREVISAO DO INICIO';
COMMENT ON COLUMN CARGA.CAR_DTPREVFIM IS 'DATA DA PREVISAO DO TERMINO';

COMMIT WORK;
